<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chef Dashboard - Order Pin Live</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Prompt:wght@400;700;900&display=swap');
        body { font-family: 'Prompt', sans-serif; background-color: #020617; }
        .bill-card { 
            min-width: 300px; max-width: 350px;
            background: #1e293b; border-top: 10px solid #3b82f6;
            animation: fadeIn 0.4s ease-out;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="text-white p-4">
    <div class="max-w-full mx-auto">
        <div class="flex justify-between items-center mb-6 bg-slate-800 p-5 rounded-2xl border-b-4 border-blue-500 shadow-2xl">
            <div>
                <h1 class="text-2xl font-black text-blue-400 uppercase">Kitchen Monitor (OrderPin.co)</h1>
                <p id="status" class="text-green-400 font-bold italic text-sm">‚óè ‡∏£‡∏∞‡∏ö‡∏ö‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏±‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</p>
            </div>
            <div class="flex gap-2">
                <button onclick="location.reload()" class="bg-slate-700 px-3 py-1 rounded-lg text-xs font-bold">RELOAD</button>
                <button onclick="clearOrders()" class="bg-red-600/20 text-red-500 px-3 py-1 rounded-lg text-xs font-bold border border-red-500">CLEAR ALL</button>
            </div>
        </div>

        <div id="orderQueue" class="flex flex-wrap gap-6 justify-start items-start pb-40">
            <div id="placeholder" class="text-slate-700 italic text-xl p-20 w-full text-center border-4 border-dashed border-slate-900 rounded-3xl">
                ‡∏£‡∏≠‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤ POS... (‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤ Order Pin ‡πÑ‡∏ß‡πâ‡πÉ‡∏ô Tab ‡∏Ç‡πâ‡∏≤‡∏á‡πÜ)
            </div>
        </div>
    </div>

    <script>
        let API_KEY = localStorage.getItem('chef_api_key') || "";
        const MODEL = "gemini-1.5-flash";

        // ‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡πâ‡∏≤‡∏° Domain ‡∏ú‡πà‡∏≤‡∏ô LocalStorage
        window.addEventListener('storage', (event) => {
            if (event.key === 'latest_order_pin' && event.newValue) {
                const data = JSON.parse(event.newValue);
                processOrderData(data);
                localStorage.removeItem('latest_order_pin'); // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ã‡πâ‡∏≥
            }
        });

        // ‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡∏£‡∏≠‡∏á: ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ó‡∏∏‡∏Å 2 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ ‡πÄ‡∏ú‡∏∑‡πà‡∏≠ Event ‡πÑ‡∏°‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
        setInterval(() => {
            const saved = localStorage.getItem('latest_order_pin');
            if (saved) {
                processOrderData(JSON.parse(saved));
                localStorage.removeItem('latest_order_pin');
            }
        }, 2000);

        async function processOrderData(jsonData) {
            if(!API_KEY) {
                API_KEY = prompt("‡πÉ‡∏™‡πà API Key ‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö‡πÄ‡∏ä‡∏ü:");
                if(API_KEY) localStorage.setItem('chef_api_key', API_KEY);
                return;
            }

            const status = document.getElementById('status');
            status.innerText = "üåÄ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...";
            status.className = "text-yellow-400 font-bold italic animate-pulse";

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1/models/${MODEL}:generateContent?key=${API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ 
                            text: `‡∏™‡∏£‡∏∏‡∏õ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏à‡∏≤‡∏Å JSON: ‡∏ö‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡πÇ‡∏ï‡πä‡∏∞‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£ ‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏ä‡πâ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢ () ‡πÅ‡∏•‡∏∞ + ‡∏£‡∏ß‡∏°‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏ï‡πà‡∏≠‡∏ó‡πâ‡∏≤‡∏¢‡πÄ‡∏°‡∏ô‡∏π ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ${JSON.stringify(jsonData)}` 
                        }] }]
                    })
                });
                const resData = await response.json();
                const result = resData.candidates[0].content.parts[0].text.trim();
                
                if (document.getElementById('placeholder')) document.getElementById('placeholder').remove();

                // ‡πÅ‡∏¢‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏ï‡πä‡∏∞‡∏ñ‡πâ‡∏≤ AI ‡∏™‡πà‡∏á‡∏°‡∏≤‡∏´‡∏•‡∏≤‡∏¢‡πÇ‡∏ï‡πä‡∏∞
                const tables = result.split(/‡πÇ‡∏ï‡πä‡∏∞|Table/gi).filter(t => t.trim().length > 3);
                tables.forEach(t => addOrderToUI("‡πÇ‡∏ï‡πä‡∏∞ " + t.replace(/[()+]/g, ' ')));

                status.innerText = "‚óè READY";
                status.className = "text-green-400 font-bold italic";
            } catch (e) {
                status.innerText = "‚ùå ERROR: ‡πÄ‡∏ä‡πá‡∏Ñ API Key";
            }
        }

        function addOrderToUI(text) {
            const queue = document.getElementById('orderQueue');
            const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            const lines = text.split('\n').filter(l => l.trim() !== "");
            const table = lines[0];
            const items = lines.slice(1).join('<br>');

            const card = document.createElement('div');
            card.className = "bill-card p-6 rounded-2xl shadow-2xl relative flex-none";
            card.innerHTML = `
                <div class="text-4xl font-black text-yellow-400 border-b border-slate-700 mb-3 pb-1">${table}</div>
                <div class="text-2xl font-bold text-white leading-tight">${items}</div>
                <div class="text-xs text-slate-500 mt-4 text-right">${time}</div>
                <button onclick="this.parentElement.remove()" class="absolute -top-2 -right-2 bg-red-600 w-8 h-8 rounded-full font-bold">‚úï</button>
            `;
            queue.appendChild(card);
        }

        function clearOrders() { location.reload(); }
    </script>
</body>
</html>
